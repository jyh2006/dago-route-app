<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Multi-stop Route Optimizer</title>

  <!-- Kakao Map JS SDK (use your JavaScript key here, NOT the REST key) -->
  <script
    type="text/javascript"
    src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8b7b21da7e0d2bd017923a63babcf36f&libraries=services"
  ></script>

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: #f4f6fb;
    }

    .hidden { display: none !important; }

    #app {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    /* Generic screens */
    .screen {
      width: 100%;
      height: 100%;
    }

    /* 1) HOME SCREEN --------------------------------------------------- */

    .screen-home {
      padding: 24px 24px 32px;
      box-sizing: border-box;
    }

    .home-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #4c55ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 22px;
      box-shadow: 0 8px 20px rgba(76, 85, 255, 0.3);
    }

    .brand-name {
      font-weight: 700;
      font-size: 20px;
    }

    .brand-sub {
      font-size: 13px;
      color: #868e96;
    }

    .icon-button {
      border: none;
      background: #ffffff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.06);
      cursor: pointer;
    }

    .home-time-block {
      margin-top: 32px;
      margin-bottom: 16px;
    }

    .home-time {
      font-size: 36px;
      font-weight: 600;
    }

    .home-date {
      font-size: 14px;
      color: #868e96;
    }

    .home-card {
      margin-top: 12px;
      background: #ffffff;
      border-radius: 24px;
      padding: 20px 20px 16px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
    }

    .home-card-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .home-card-label {
      font-size: 13px;
      color: #868e96;
    }

    .home-card-main {
      margin-top: 4px;
      font-size: 32px;
      font-weight: 700;
      color: #4c55ff;
    }

    .home-card-secondary {
      margin-top: 4px;
      font-size: 20px;
      font-weight: 700;
    }

    .home-card-icon {
      width: 56px;
      height: 56px;
      border-radius: 20px;
      background: #f2f0ff;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 28px;
    }

    .home-card-divider {
      margin: 14px 0;
      height: 1px;
      background: #f1f3f5;
    }

    .stops-input-box {
      margin-top: 24px;
    }

    .stops-label {
      display: block;
      margin-bottom: 6px;
      font-size: 13px;
      color: #868e96;
    }

    .stops-textarea {
      width: 100%;
      height: 100px;
      border-radius: 16px;
      border: none;
      padding: 12px;
      font-size: 14px;
      box-sizing: border-box;
      resize: vertical;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    .primary-button {
      margin-top: 28px;
      width: 100%;
      border-radius: 22px;
      border: none;
      padding: 18px 20px;
      font-size: 17px;
      font-weight: 600;
      color: #ffffff;
      background: linear-gradient(135deg, #4c55ff, #a445ff);
      box-shadow: 0 14px 30px rgba(76, 85, 255, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
    }

    .primary-icon { font-size: 18px; }

    .secondary-button {
      margin-top: 12px;
      width: 100%;
      border-radius: 22px;
      padding: 16px 20px;
      border: 1px solid #dee2e6;
      background: #ffffff;
      font-size: 15px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
    }

    .secondary-icon { font-size: 18px; }

    /* 2) LOADING SCREEN ------------------------------------------------ */

    .screen-loading .loading-gradient {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #4c55ff, #a445ff);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .loading-content {
      text-align: center;
      color: #e7e9ff;
    }

    .loading-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .loading-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .loading-sub {
      font-size: 15px;
      opacity: 0.9;
    }

    /* 3) NAVIGATION SCREEN --------------------------------------------- */

    .screen-nav {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .nav-top {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 14px 18px 6px;
    }

    .nav-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .circle-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: #ffffff;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      cursor: pointer;
    }

    .nav-progress-pill {
      padding: 8px 16px;
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
      font-size: 14px;
    }

    .nav-main {
      flex: 1;
      display: grid;
      grid-template-columns: 120px minmax(0, 1fr) 64px;
      gap: 0;
    }

    /* left */
    .nav-left {
      background: linear-gradient(180deg, #4c55ff, #3226b5);
      color: #ffffff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 40px 16px 24px;
      box-sizing: border-box;

      /* NEW: make the 'ë‹¤ìŒ' button position relative to this panel
         and reserve space at the bottom so it doesn't clash visually */
      position: relative;
      padding-bottom: 90px;
    }

    .nav-direction-card {
      width: 80px;
      height: 80px;
      border-radius: 24px;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }

    .nav-arrow {
      font-size: 40px;
    }

    .nav-distance-main {
      font-size: 36px;
      font-weight: 700;
    }

    .nav-distance-unit {
      font-size: 16px;
      margin-left: 4px;
    }

    .nav-distance-sub {
      margin-top: 4px;
      font-size: 15px;
    }

    .nav-next-step-box {
      position: absolute;
      bottom: 24px;
      left: 16px;
      right: 16px;
      border-radius: 14px;
      background: rgba(255,255,255,0.15);
      padding: 10px;
      font-size: 13px;

      /* NEW for button behaviour / nicer look */
      border: none;
      outline: none;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      text-align: left;
      background: rgba(255,255,255,0.2);
      box-shadow: 0 6px 14px rgba(0,0,0,0.25);
    }

    .nav-next-label {
      opacity: 0.85;
      margin-bottom: 2px;
    }

    .nav-next-info {
      font-weight: 500;
    }

    /* map */
    .nav-map-wrapper {
      background: #f8f9fa;
    }

    .nav-map {
      width: 100%;
      height: 100%;
    }

    /* right toolbar */
    .nav-right-toolbar {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 80px;
      gap: 12px;
    }

    .toolbar-btn {
      width: 40px;
      height: 40px;
      border-radius: 16px;
      border: none;
      background: #ffffff;
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
      cursor: pointer;
    }

    /* bottom sheet */
    .nav-bottom-sheet {
      padding: 16px 20px 20px;
      border-radius: 24px 24px 0 0;
      background: #ffffff;
      box-shadow: 0 -10px 30px rgba(0,0,0,0.10);
    }

    .nav-bottom-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .nav-bottom-label {
      font-size: 13px;
      color: #868e96;
    }

    .nav-bottom-main {
      font-size: 20px;
      font-weight: 700;
    }

    .nav-voice-btn {
      width: 56px;
      height: 56px;
      border-radius: 999px;
      border: none;
      background: #4c55ff;
      color: #ffffff;
      font-size: 24px;
      box-shadow: 0 10px 26px rgba(76, 85, 255, 0.6);
      cursor: pointer;
    }

    .nav-bottom-right {
      text-align: right;
    }

    .nav-destination-info {
      margin-top: 14px;
    }

    .nav-dest-line {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .nav-dest-title {
      font-size: 16px;
      font-weight: 600;
    }

    .nav-dest-sub {
      font-size: 13px;
      color: #868e96;
    }

    .nav-complete-btn {
      margin-top: 16px;
      width: 100%;
      border-radius: 999px;
      padding: 14px 20px;
      border: none;
      background: #12b886;
      color: #ffffff;
      font-size: 16px;
      font-weight: 600;
      box-shadow: 0 12px 28px rgba(18, 184, 134, 0.5);
      cursor: pointer;
    }

    .nav-progress-track {
      width: 100%;
      height: 4px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
    }

    .nav-progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #4c55ff, #a445ff);
      border-radius: inherit;
      transition: width 0.25s ease-out;
    }
    .stop-marker {
      min-width: 26px;
      height: 26px;
      padding: 0 4px;
      border-radius: 999px;
      background: #4c55ff;
      color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.35);
      border: 2px solid #ffffff;
      transform: translate(-50%, -50%);
      white-space: nowrap;
    }
    .stop-marker.stop-start {
      background: #6b7280; /* ì¶œë°œì§€ìš© ì¤‘ê°„ íšŒìƒ‰ (ì›í•˜ëŠ” ìƒ‰ìœ¼ë¡œ ë°”ê¿”ë„ ë¨) */
    }

    .stop-marker.stop-done {
      background: #12b886;   /* same green as ë°°ì†¡ ì™„ë£Œ ë²„íŠ¼ */
    }

    /* 4) DONE SCREEN ---------------------------------------------------- */

    .screen-done {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #e6fff3;
    }

    .done-wrapper {
      text-align: center;
    }

    /* big green pill with check icon */
    .done-pill {
      width: 260px;
      height: 140px;
      border-radius: 999px;
      background: #12b886;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 32px;
      box-shadow: 0 20px 45px rgba(18, 184, 134, 0.55);
    }

    .done-pill-icon {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      border: 4px solid #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      color: #ffffff;
    }

    /* main title & summary text under the pill */
    .done-main-title {
      font-size: 26px;
      font-weight: 800;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .done-main-sub {
      font-size: 16px;
      color: #4b5563;
    }

    /* button at bottom */
    .done-main-btn {
      margin-top: 28px;
      padding: 14px 32px;
      border-radius: 999px;
      border: none;
      background: #4c55ff;
      color: #ffffff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 16px 32px rgba(76, 85, 255, 0.45);
    }
  /* =========================
     MOBILE LAYOUT (â‰¤ 768px)
     ========================= */
  @media (max-width: 768px) {
    body {
      background: #f4f6fb;
    }

    #app {
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }

    /* ---------- HOME SCREEN ---------- */
    .screen-home {
      padding: 24px 18px 32px;
      max-width: 420px;
      margin: 0 auto;
      align-items: flex-start;
    }

    .home-header {
      padding-top: 8px;
    }

    .brand-logo {
      width: 36px;
      height: 36px;
      font-size: 20px;
    }

    .brand-name {
      font-size: 18px;
    }

    .home-time-block {
      margin-top: 24px;
      margin-bottom: 12px;
    }

    .home-time {
      font-size: 32px;
      font-weight: 600;
    }

    .home-date {
      font-size: 13px;
    }

    .home-card {
      margin-top: 8px;
      border-radius: 20px;
      padding: 16px 18px 14px;
    }

    .home-card-main {
      font-size: 28px;
    }

    .home-card-secondary {
      font-size: 15px;
    }

    .home-actions {
      margin-top: 24px;
      gap: 12px;
    }

    .primary-button,
    .secondary-button {
      width: 100%;
      border-radius: 999px;
      padding: 14px 0;
      font-size: 15px;
    }

    /* ---------- NAVIGATION SCREEN ---------- */
    .screen-nav {
      display: flex;
      flex-direction: column;
    }

    .nav-top {
      padding: 12px 12px 8px;
    }

    .nav-top-row {
      gap: 10px;
    }

    .nav-progress-pill {
      padding: 6px 12px;
      font-size: 11px;
    }

    .nav-main {
      flex: 1;
      display: grid;                  /* 2-column layout: left bar + map */
      grid-template-columns: 80px minmax(0, 1fr);
      grid-template-rows: 1fr;
      gap: 0;
      position: relative;
    }

    .nav-left {
      grid-column: 1;
      grid-row: 1;
      padding: 24px 8px 24px;
      padding-bottom: 24px;           /* no extra gap at bottom */
      box-sizing: border-box;
    }

    .nav-direction-card {
      width: 64px;
      height: 64px;
      border-radius: 20px;
      margin-bottom: 10px;
    }

    .nav-arrow {
      font-size: 30px;
    }

    .nav-distance-main {
      font-size: 26px;
    }

    .nav-distance-sub {
      font-size: 13px;
    }

    .nav-next-step-box {
      position: static;               /* becomes a small card inside bar */
      width: 100%;
      margin-top: 16px;
      border-radius: 14px;
      padding: 8px;
      font-size: 11px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }

    .nav-map-wrapper {
      grid-column: 2;
      grid-row: 1;
      background: #f8f9fa;
    }

    .nav-map {
      width: 100%;
      height: 100%;
    }

    /* Right toolbar floats over the map */
    .nav-right-toolbar {
      position: absolute;
      top: 50%;
      right: 12px;
      transform: translateY(-50%);
      flex-direction: column;
      gap: 8px;
    }

    .toolbar-btn {
      width: 40px;
      height: 40px;
      border-radius: 16px;
    }

    /* Bottom sheet like in mockup */
    .nav-bottom-sheet {
      padding: 12px 16px 16px;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -10px 30px rgba(0,0,0,0.12);
    }

    .nav-bottom-row {
      margin-bottom: 10px;
    }

    .nav-bottom-label {
      font-size: 12px;
    }

    .nav-bottom-main {
      font-size: 18px;
    }

    .nav-voice-btn {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      font-size: 22px;
    }

    .nav-dest-title {
      font-size: 15px;
    }

    .nav-dest-sub {
      font-size: 12px;
    }

    .nav-complete-btn {
      margin-top: 12px;
      width: 100%;
      border-radius: 999px;
      padding: 14px 20px;
      font-size: 15px;
    }
  }
  </style>
</head>
<body>
  <div id="app">

    <!-- 1) HOME SCREEN -->
    <section id="screen-home" class="screen screen-home">
      <header class="home-header">
        <div class="brand">
          <div class="brand-logo">âš¡</div>
          <div class="brand-text">
            <div class="brand-name">DAGO</div>
            <div class="brand-sub">ë‹¤ê³ </div>
          </div>
        </div>
        <button class="icon-button" id="settingsBtn">âš™ï¸</button>
      </header>

      <div class="home-time-block">
        <div class="home-time" id="homeTime">ì˜¤ì „ 01:31</div>
        <div class="home-date" id="homeDate">12ì›” 7ì¼ (ì¼)</div>
      </div>

      <div class="home-card">
        <div class="home-card-row">
          <div>
            <div class="home-card-label">ì˜¤ëŠ˜ì˜ ë°°ì†¡ì§€</div>
            <div class="home-card-main" id="todayStopsCount">0</div>
          </div>
          <div class="home-card-icon">ğŸ“¦</div>
        </div>
        <div class="home-card-divider"></div>
        <div class="home-card-row">
          <div>
            <div class="home-card-label">ì´ ì†¡ì¥</div>
            <div class="home-card-secondary" id="totalParcels">0ê±´</div>
          </div>
        </div>
      </div>

      <!-- For now, a simple textarea for stops (you can replace later with a nicer UI) -->
      <div class="stops-input-box">
        <label class="stops-label">ë°°ì†¡ì§€ ëª©ë¡ (í•œ ì¤„ì— í•œ ê°œ)</label>
        <textarea id="stopsInput" class="stops-textarea"
          placeholder="ê²½ë³µê¶ì—­&#10;ì„œìš¸ì—­&#10;ë‚¨ì‚°ì„œìš¸íƒ€ì›Œ&#10;ì ì‹¤ì¢…í•©ìš´ë™ì¥ì—­"></textarea>
      </div>

      <button id="startRouteBtn" class="primary-button">
        <span class="primary-icon">â¤</span>
        <span>ê²½ë¡œ ì•ˆë‚´ ì‹œì‘</span>
      </button>

      <button id="editStopsBtn" class="secondary-button">
        <span class="secondary-icon">ğŸ“¦</span>
        <span>ì†¡ì¥ ì¶”ê°€/í¸ì§‘</span>
      </button>
    </section>

    <!-- 2) LOADING SCREEN -->
    <section id="screen-loading" class="screen screen-loading hidden">
      <div class="loading-gradient">
        <div class="loading-content">
          <div class="loading-icon">â¤</div>
          <div class="loading-title">ìµœì  ê²½ë¡œ ê³„ì‚° ì¤‘â€¦</div>
          <div class="loading-sub">AIê°€ ìµœì ì˜ ë°°ì†¡ ìˆœì„œë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤</div>
        </div>
      </div>
    </section>

    <!-- 3) NAVIGATION SCREEN -->
    <section id="screen-nav" class="screen screen-nav hidden">
      <header class="nav-top">
        <div class="nav-top-row">
          <button id="navBackBtn" class="circle-button">â†</button>
          <div class="nav-progress-pill">
            <span id="navProgressText">0 / 0 ì™„ë£Œ</span>
          </div>
        </div>
        <div class="nav-progress-track">
          <div class="nav-progress-fill" id="navProgressFill"></div>
        </div>
      </header>

      <div class="nav-main">
        <!-- Left column: next turn + distance -->
        <div class="nav-left">
          <!-- í´ë¦­í•´ì„œ ë‹¤ìŒ step ìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” ë²„íŠ¼ -->
          <div class="nav-direction-card">
            <div class="nav-arrow" id="navArrow">â†‘</div>
          </div>

          <!-- í˜„ì¬ step ê±°ë¦¬ / ì•ˆë‚´ ë¬¸êµ¬ -->
          <div class="nav-distance-main">
            <span id="currentStepDistance">0</span><span class="nav-distance-unit">m</span>
          </div>
          <div class="nav-distance-sub" id="currentStepInstruction">ì§ì§„</div>

          <!-- ë‹¤ìŒ step ë¯¸ë¦¬ë³´ê¸° -->
          <button class="nav-next-step-box" id="stepAdvanceBtn" type="button">
            <div class="nav-next-label">ë‹¤ìŒ</div>
            <div class="nav-next-info">
              <span id="nextDistance">-</span>
              <span id="nextInstruction"></span>
            </div>
          </button>
        </div>


        <!-- Center: MAP -->
        <div class="nav-map-wrapper">
          <div id="map" class="nav-map"></div>
        </div>

        <!-- Right: vertical icons (stubbed) -->
        <div class="nav-right-toolbar">
          <button class="toolbar-btn">ğŸš§</button>
          <button class="toolbar-btn">âš ï¸</button>
          <button class="toolbar-btn">ğŸšŒ</button>
          <button class="toolbar-btn">ğŸ—ï¸</button>
          <button class="toolbar-btn">â„¹ï¸</button>
          <button class="toolbar-btn">ğŸ—ºï¸</button>
        </div>
      </div>

      <!-- Bottom sheet -->
      <div class="nav-bottom-sheet">
        <div class="nav-bottom-row">
          <div>
            <div class="nav-bottom-label">ë‚¨ì€ ê±°ë¦¬</div>
            <div class="nav-bottom-main" id="remainingDistance">0 km</div>
          </div>
          <button id="voiceBtn" class="nav-voice-btn">ğŸ¤</button>
          <div class="nav-bottom-right">
            <div class="nav-bottom-label">ë„ì°© ì˜ˆì •</div>
            <div class="nav-bottom-main" id="etaText">0ë¶„</div>
          </div>
        </div>

        <div class="nav-destination-info">
          <div class="nav-dest-line">
            <span class="nav-dest-pin">ğŸ“</span>
            <span class="nav-dest-title" id="destTitle">ëª©ì ì§€ 1/1</span>
          </div>
          <div class="nav-dest-sub" id="destSub">ì„œìš¸íŠ¹ë³„ì‹œ ...</div>
        </div>

        <button id="completeStopBtn" class="nav-complete-btn">
          âœ“ ë°°ì†¡ ì™„ë£Œ
        </button>
      </div>
    </section>

    <!-- 4) DONE SCREEN -->
    <section id="screen-done" class="screen screen-done hidden">
      <div class="done-wrapper">
        <!-- big green pill with check -->
        <div class="done-pill">
          <div class="done-pill-icon">âœ“</div>
        </div>

        <!-- title + summary text -->
        <div class="done-main-title">ë°°ì†¡ ì™„ë£Œ!</div>
        <div class="done-main-sub" id="doneSummary">
          ì´ 0ê±´ì˜ ë°°ì†¡ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤
        </div>

        <!-- back button -->
        <button id="backToMainBtn" class="done-main-btn">
          ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </button>
      </div>
    </section>
  </div>

  <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
  <!-- include your Kakao map JS & any OSRM helper scripts as before -->

  <script>
    /* === SIMPLE SCREEN STATE MANAGEMENT === */

    const screens = {
      home: document.getElementById("screen-home"),
      loading: document.getElementById("screen-loading"),
      nav: document.getElementById("screen-nav"),
      done: document.getElementById("screen-done"),
    };

    function showScreen(name) {
      for (const key in screens) {
        screens[key].classList.add("hidden");
      }
      screens[name].classList.remove("hidden");
    }

    // Elements
    const stopsInput     = document.getElementById("stopsInput");
    const startRouteBtn  = document.getElementById("startRouteBtn");
    const completeStopBtn= document.getElementById("completeStopBtn");
    const backToMainBtn  = document.getElementById("backToMainBtn");
    const navBackBtn     = document.getElementById("navBackBtn");

    const navProgressText= document.getElementById("navProgressText");
    const destTitle      = document.getElementById("destTitle");
    const destSub        = document.getElementById("destSub");
    const remainingDistance = document.getElementById("remainingDistance");
    const etaText        = document.getElementById("etaText");
    const navProgressFill = document.getElementById("navProgressFill");

    const nextDistance          = document.getElementById("nextDistance");
    const nextInstruction       = document.getElementById("nextInstruction");
    const currentStepDistance   = document.getElementById("currentStepDistance");
    const currentStepInstruction= document.getElementById("currentStepInstruction");
    const stepAdvanceBtn        = document.getElementById("stepAdvanceBtn"); // now the 'ë‹¤ìŒ' button
    const navArrow              = document.getElementById("navArrow");

    const doneSummary    = document.getElementById("doneSummary");
    const todayStopsCount= document.getElementById("todayStopsCount");

    function refreshTodayStopsCountFromInput() {
      if (!stopsInput || !todayStopsCount) return;
      const count = stopsInput.value
        .split("\n")
        .map(l => l.trim())
        .filter(l => l.length > 0).length;
      todayStopsCount.textContent = count;
    }

    // Route state
    let routeData = null;          // full response from backend
    let currentStopIndex = 0;      // which destination (0..n-1)
    let totalStops = 0;
    let completedStops = 0;
    let currentStepIndex = 0;

    let mapInitialized = false;
    let kakaoMap = null;
    let mainRoutePolyline = null;
    let stepHighlightPolyline = null;
    // [{ overlay, routePos, stopIndex, done }]
    let stopOverlays = [];   // ë²ˆí˜¸ ë§ˆì»¤ ì €ì¥ìš©

    function ensureMap() {
      if (mapInitialized) return;
      const mapContainer = document.getElementById("map");
      kakaoMap = new kakao.maps.Map(mapContainer, {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 7,
      });
      mapInitialized = true;
    }

    function renderRouteOnMap(routeData) {
      if (!kakaoMap) return;

      // Clear old line
      if (mainRoutePolyline) {
        mainRoutePolyline.setMap(null);
        mainRoutePolyline = null;
      }

      // ê¸°ì¡´ ë²ˆí˜¸ ë§ˆì»¤ ì œê±°
      if (stopOverlays.length) {
        stopOverlays.forEach(o => {
          if (o && o.overlay && typeof o.overlay.setMap === "function") {
            o.overlay.setMap(null);
          }
        });
        stopOverlays = [];
      }

      const steps = routeData.osrm_steps || routeData.osrm_turns || [];
      if (!steps.length) return;

      // Flatten all step polylines into one long list of coords
      let fullRoadCoords = [];
      steps.forEach((step) => {
        const stepCoords = step.polyline || [];
        if (!Array.isArray(stepCoords) || !stepCoords.length) return;

        if (fullRoadCoords.length === 0) {
          fullRoadCoords = stepCoords.slice();
        } else {
          const last = fullRoadCoords[fullRoadCoords.length - 1];
          const first = stepCoords[0];
          const same =
            last &&
            first &&
            last.length === 2 &&
            first.length === 2 &&
            last[0] === first[0] &&
            last[1] === first[1];

          const startIdx = same ? 1 : 0;
          for (let i = startIdx; i < stepCoords.length; i++) {
            fullRoadCoords.push(stepCoords[i]);
          }
        }
      });

      if (!fullRoadCoords.length) return;

      const path = fullRoadCoords.map(
        ([lat, lon]) => new kakao.maps.LatLng(lat, lon)
      );

      mainRoutePolyline = new kakao.maps.Polyline({
        map: kakaoMap,
        path,
        strokeWeight: 6,
        strokeColor: "#f97316",
        strokeOpacity: 0.9,
        strokeStyle: "solid",
      });

      // === ë²ˆí˜¸ ë§ˆì»¤ ì¶”ê°€ (ë°©ë¬¸ ìˆœì„œ ê¸°ì¤€ 1,2,3,...) ===
      if (routeData.stops && Array.isArray(routeData.stops)) {
        const baseStops = routeData.stops;
        // ë°©ë¬¸ ìˆœì„œë¥¼ ë‚˜íƒ€ë‚´ëŠ” ë°°ì—´ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ 0..N-1
        const order =
          (Array.isArray(routeData.route_indices) && routeData.route_indices.length === baseStops.length)
            ? routeData.route_indices
            : baseStops.map((_, i) => i);

        stopOverlays = order.map((stopIdx, routePos) => {
          const s = baseStops[stopIdx];
          if (!s || s.lat == null || s.lon == null) return null;

          const pos = new kakao.maps.LatLng(s.lat, s.lon);

          // 0ë²ˆ = ì¶œë°œì§€, 1ë²ˆë¶€í„° ì‹¤ì œ ëª©ì ì§€ ë²ˆí˜¸
          const isStart = (routePos === 0);
          const label   = isStart ? "ì¶œë°œì§€" : String(routePos);
          const classes = isStart ? "stop-marker stop-start" : "stop-marker";

          const content = `<div class="${classes}">${label}</div>`;
          const overlay = new kakao.maps.CustomOverlay({
            position: pos,
            content,
            yAnchor: 1,
            zIndex: 10,
          });

          overlay.setMap(kakaoMap);

          return {
            overlay,
            routePos,   // 0,1,2,... in ë°©ë¬¸ ìˆœì„œ
            stopIndex: stopIdx,
            done: false,
          };
        }).filter(Boolean);
      }

      const bounds = new kakao.maps.LatLngBounds();
      path.forEach((p) => bounds.extend(p));
      if (!bounds.isEmpty()) {
        kakaoMap.setBounds(bounds, 40, 40, 40, 40);
      }
    }

    function markStopDone(routePos) {
      if (!stopOverlays || routePos < 0) return;
      const obj = stopOverlays[routePos];
      if (!obj || obj.done) return;

      obj.done = true;

      // 0ë²ˆ = ì¶œë°œì§€, 1ë²ˆë¶€í„° ì‹¤ì œ ëª©ì ì§€ ë²ˆí˜¸
      const isStart = (obj.routePos === 0);
      const label   = isStart ? "ì¶œë°œì§€" : String(obj.routePos);
      const classes = isStart ? "stop-marker stop-start stop-done"
                              : "stop-marker stop-done";

      const newHtml = `<div class="${classes}">${label}</div>`;
      obj.overlay.setContent(newHtml);
    }

    function highlightCurrentStepOnMap() {
      if (!kakaoMap || !routeData) return;

      const steps = routeData.osrm_steps || routeData.osrm_turns || [];
      if (!steps.length) return;

      if (currentStepIndex < 0 || currentStepIndex >= steps.length) return;
      const step = steps[currentStepIndex];
      const coords = step.polyline || [];
      if (!Array.isArray(coords) || !coords.length) return;

      // ì´ì „ í•˜ì´ë¼ì´íŠ¸ ì œê±°
      if (stepHighlightPolyline) {
        stepHighlightPolyline.setMap(null);
        stepHighlightPolyline = null;
      }

      const path = coords.map(([lat, lon]) => new kakao.maps.LatLng(lat, lon));

      stepHighlightPolyline = new kakao.maps.Polyline({
        map: kakaoMap,
        path,
        strokeWeight: 8,
        strokeColor: "#38bdf8", // íŒŒë€ìƒ‰
        strokeOpacity: 0.9,
        strokeStyle: "solid",
      });

      // í˜„ì¬ step ì¤‘ì‹¬ìœ¼ë¡œ ë³´ê¸°
      const bounds = new kakao.maps.LatLngBounds();
      path.forEach(p => bounds.extend(p));
      if (!bounds.isEmpty()) {
        kakaoMap.setBounds(bounds, 40, 40, 40, 40);
      }
    }

    // Promise wrapper for browser geolocation
    function getCurrentPositionAsync(options) {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          console.warn("Geolocation not supported; starting from first typed stop.");
          return resolve(null);
        }

        navigator.geolocation.getCurrentPosition(
          (position) => resolve(position),
          (err) => {
            console.warn("Geolocation error:", err);
            resolve(null); // fall back gracefully
          },
          options
        );
      });
    }

    // Call backend to optimize route
    async function requestOptimizedRoute() {
      const raw = stopsInput.value
        .split("\n")
        .map(l => l.trim())
        .filter(l => l.length > 0);

      if (raw.length === 0) {
        alert("ë°°ì†¡ì§€ë¥¼ í•œ ê°œ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      // ì˜¤ëŠ˜ ë°°ì†¡ì§€ ê°œìˆ˜ëŠ” 'ëª©ì ì§€ ìˆ˜'ë§Œ ë³´ì—¬ì£¼ê³ , í˜„ì¬ ìœ„ì¹˜ëŠ” ì œì™¸
      todayStopsCount.textContent = raw.length;

      showScreen("loading");

      try {
        // 1) ë¨¼ì € í˜„ì¬ ìœ„ì¹˜ ì‹œë„
        let lines = [];
        try {
          const pos = await getCurrentPositionAsync({
            enableHighAccuracy: true,
            timeout: 8000,
            maximumAge: 0,
          });

          if (pos) {
            const { latitude, longitude } = pos.coords;
            // ì„œë²„ì˜ geocode_line() ì€ "lat,lon" í˜•íƒœë¥¼ ê·¸ëŒ€ë¡œ ë°›ì•„ì„œ Kakao ì—†ì´ ì‚¬ìš©í•¨
            // (í˜„ì¬ ìœ„ì¹˜ë¥¼ ì²« ë²ˆì§¸ ë…¸ë“œ = ì¶œë°œì§€ë¡œ ê°•ì œ)
            lines.push(`${latitude},${longitude} # í˜„ì¬ ìœ„ì¹˜`);
          }
        } catch (e) {
          console.warn("Failed to obtain current position:", e);
          // ì‹¤íŒ¨í•´ë„ ê·¸ëƒ¥ í…ìŠ¤íŠ¸ë¡œë§Œ ê²½ë¡œ ìµœì í™”
        }

        // 2) ë‚˜ë¨¸ì§€ ë°°ì†¡ì§€ë“¤ì„ ê·¸ëŒ€ë¡œ ë’¤ì— ë¶™ì¸ë‹¤
        lines = lines.concat(raw);

        const API_BASE = "https://dago-route-app.onrender.com";  // FastAPI port

        const res = await fetch(`${API_BASE}/optimize-by-name`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            lines: lines,
            // í•­ìƒ index 0 = í˜„ì¬ ìœ„ì¹˜ (ì„±ê³µ ì‹œ)
            // ë§Œì•½ GPS ì‹¤íŒ¨í•˜ë©´, index 0 = ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì²« ë²ˆì§¸ ë°°ì†¡ì§€
            start_index: 0,
            end_index: lines.length - 1,  // ë§ˆì§€ë§‰ ë…¸ë“œì—ì„œ ëë‚˜ëŠ” open path
          }),
        });

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text);
        }

        routeData = await res.json();
        // Assume routeData has: stops, legs, osrm_steps, total_distance_m, total_time_s
        totalStops = routeData.stops.length;
        completedStops = 0;
        currentStopIndex = 0;
        currentStepIndex = 0;   // <- reset current step

        // 1) Show the navigation screen so the map container has a real size
        showScreen("nav");

        // 2) Now create the Kakao map (only first time)
        ensureMap();

        // 3) Draw the OSRM route on the Kakao map
        renderRouteOnMap(routeData);

        // 4) Update navigation UI texts
        updateNavUI();
        highlightCurrentStepOnMap();

        // 5) Tell Kakao map to recalc layout (important after showing a hidden div)
        if (kakaoMap) {
          kakao.maps.event.trigger(kakaoMap, "resize");
        }
      } catch (err) {
        console.error(err);
        alert("ê²½ë¡œ ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
        showScreen("home");
      }
    }

    function updateNavUI() {
      if (!routeData) return;

      const steps = routeData.osrm_steps || routeData.osrm_turns || [];

      // ì¶œë°œì§€(0ë²ˆ)ë¥¼ ì œì™¸í•œ ì‹¤ì œ ëª©ì ì§€ ê°œìˆ˜
      const totalDestStops = Math.max(0, totalStops - 1);

      // í˜„ì¬ step ì´ ì†í•œ leg_index ê¸°ì¤€ìœ¼ë¡œ "ë„ì°© ë…¸ë“œ"ì˜ ë°©ë¬¸ ìˆœì„œë¥¼ ê³„ì‚°
      let destRoutePos = currentStopIndex; // fallback
      if (steps.length && currentStepIndex >= 0 && currentStepIndex < steps.length) {
        const curLeg = steps[currentStepIndex].leg_index ?? 0;
        // leg 0 : 0â†’1 ì´ë™ â†’ ë„ì°© ë…¸ë“œ routePos = 1
        // leg 1 : 1â†’2 ì´ë™ â†’ ë„ì°© ë…¸ë“œ routePos = 2 ...
        destRoutePos = curLeg + 1;
      }

      // route ë²”ìœ„ ì•ˆìœ¼ë¡œ í´ë¨í”„
      if (totalStops > 1) {
        // 0ë²ˆì€ ì¶œë°œì§€ì´ë¯€ë¡œ ìµœì†Œ 1ë¶€í„° ëª©ì ì§€
        destRoutePos = Math.max(1, Math.min(totalStops - 1, destRoutePos));
      } else {
        destRoutePos = 0; // ëª©ì ì§€ê°€ ì•„ì˜ˆ ì—†ëŠ” ê²½ìš°
      }
      currentStopIndex = destRoutePos;

      navProgressText.textContent = `${completedStops} / ${totalDestStops} ì™„ë£Œ`;
      if (navProgressFill) {
        const ratio = totalDestStops > 0 ? completedStops / totalDestStops : 0;
        navProgressFill.style.width = Math.min(100, ratio * 100) + "%";
      }

      // route_indices ë¡œ ì‹¤ì œ ëª©ì ì§€ ì¸ë±ìŠ¤ ê°€ì ¸ì˜¤ê¸°
      const baseStops = routeData.stops || [];
      const order =
        (Array.isArray(routeData.route_indices) && routeData.route_indices.length === baseStops.length)
          ? routeData.route_indices
          : baseStops.map((_, i) => i);

      const destStopIdx = order[currentStopIndex] ?? 0;
      const stop = baseStops[destStopIdx] || {};

      if (currentStopIndex === 0) {
        // ì´ë¡ ìƒ ê±°ì˜ ì•ˆ ì˜¤ì§€ë§Œ, ë°©ì–´ì ìœ¼ë¡œ ì²˜ë¦¬
        destTitle.textContent = "ì¶œë°œì§€ (í˜„ì¬ ìœ„ì¹˜)";
      } else {
        const destNumber = currentStopIndex; // ì¶œë°œì§€=0, ì²« ëª©ì ì§€=1 ...
        const totalDestStops = Math.max(0, totalStops - 1);
        destTitle.textContent = `ëª©ì ì§€ ${destNumber}/${totalDestStops}`;
      }

      destSub.textContent = stop.label || stop.name || stop.address || "";

      if (!steps.length) {
        if (currentStepDistance)    currentStepDistance.textContent = "-";
        if (currentStepInstruction) currentStepInstruction.textContent = "";
        remainingDistance.textContent = "-";
        etaText.textContent = "-";
        if (nextDistance) nextDistance.textContent = "";
        if (nextInstruction) nextInstruction.textContent = "";
        if (navArrow) navArrow.textContent = "â†‘";
        return;
      }

      // step ì¸ë±ìŠ¤ ì•ˆì „ ë²”ìœ„
      if (currentStepIndex < 0) currentStepIndex = 0;
      if (currentStepIndex >= steps.length) currentStepIndex = steps.length - 1;

      const currentStep = steps[currentStepIndex];

      // ---- 1) ì™¼ìª½ ë³´ë¼ íŒ¨ë„: í˜„ì¬ step ----
      // backend ê°€ distance_m(ë¯¸í„°) ë˜ëŠ” distance_km(í‚¬ë¡œë¯¸í„°)ë¥¼ ì¤„ ìˆ˜ ìˆë‹¤ê³  ê°€ì •
      const curDistM =
        typeof currentStep.distance_m === "number" ? currentStep.distance_m :
        typeof currentStep.distance === "number" ? currentStep.distance :
        (currentStep.distance_km ? currentStep.distance_km * 1000 : 0);

      if (currentStepDistance) {
        if (curDistM >= 1000) {
          const km = curDistM / 1000;
          currentStepDistance.textContent = km.toFixed(1);
          // ë‹¨ìœ„ëŠ” ì´ë¯¸ "m"ìœ¼ë¡œ í‘œì‹œ ì¤‘ì´ì§€ë§Œ, í•„ìš”í•˜ë©´ "km"ë¡œ ë°”ê¾¸ê³  ì‹¶ì„ ìˆ˜ë„ ìˆìŒ
        } else {
          currentStepDistance.textContent = Math.round(curDistM);
        }
      }

      let curInstr = currentStep.instruction || currentStep.maneuver || "ì§ì§„";

      if (currentStepInstruction) {
        currentStepInstruction.textContent = curInstr;
      }

      // Arrow shape based on instruction
      if (navArrow) {
        const lower = curInstr.toLowerCase();
        if (lower.includes("left") || lower.includes("ì¢Œ")) {
          navArrow.textContent = "â†°"; // or "â†–"
        } else if (lower.includes("right") || lower.includes("ìš°")) {
          navArrow.textContent = "â†±"; // or "â†—"
        } else if (lower.includes("u-turn") || lower.includes("ìœ í„´")) {
          navArrow.textContent = "â†º";
        } else {
          navArrow.textContent = "â†‘";
        }
      }

      // ---- 2) ë‚¨ì€ ê±°ë¦¬ / ETA (í˜„ì¬ ëª©ì ì§€ê¹Œì§€, í˜„ì¬ step ê¸°ì¤€) ----
      let remainingMeters = 0;
      let remainingSeconds = 0;

      // leg_index ëŠ” ë°˜ë“œì‹œ backend ì—ì„œ ì±„ì›Œì¤˜ì•¼ í•¨
      const currentLeg = currentStep.leg_index;

      for (let i = currentStepIndex; i < steps.length; i++) {
        const s = steps[i];

        const legIndex = s.leg_index;
        if (legIndex !== currentLeg) break;

        const stepMeters =
          typeof s.distance_m === "number" ? s.distance_m :
          typeof s.distance === "number" ? s.distance :
          (s.distance_km ? s.distance_km * 1000 : 0);
        remainingMeters += stepMeters;

        const stepSeconds =
          typeof s.duration_s === "number" ? s.duration_s :
          typeof s.duration === "number" ? s.duration :
          (s.duration_min ? s.duration_min * 60 : 0);
        remainingSeconds += stepSeconds;
      }

      // í™”ë©´ í‘œì‹œ
      if (remainingMeters >= 1000) {
        const km = remainingMeters / 1000;
        remainingDistance.textContent = km.toFixed(1) + " km";
      } else {
        remainingDistance.textContent = Math.round(remainingMeters) + " m";
      }

      const etaMin = Math.max(1, Math.round(remainingSeconds / 60));
      etaText.textContent = etaMin + "ë¶„";

      // ---- 3) ë‹¤ìŒ step ë¯¸ë¦¬ë³´ê¸° ----
      const nextIdx = currentStepIndex + 1;
      if (nextIdx < steps.length) {
        const nextStep = steps[nextIdx];
        const nextDistM =
          nextStep.distance_m ??
          (nextStep.distance_km ? nextStep.distance_km * 1000 :
           nextStep.distance ?? 0);
        const instr = nextStep.instruction || nextStep.maneuver || "ì§ì§„";

        if (nextDistance)    nextDistance.textContent    = Math.round(nextDistM) + " m";
        if (nextInstruction) nextInstruction.textContent = instr;
      } else {
        if (nextDistance)    nextDistance.textContent    = "";
        if (nextInstruction) nextInstruction.textContent = "ëª©ì ì§€ ë¶€ê·¼";
      }
    }

    function goToNextStep() {
      if (!routeData) return;
      const steps = routeData.osrm_steps || routeData.osrm_turns || [];
      if (!steps.length) return;

      // í˜„ì¬ step ì´ ì†í•œ leg ì™€ ê·¸ leg ì˜ ë§ˆì§€ë§‰ step ì°¾ê¸°
      const curStep = steps[currentStepIndex];
      const curLeg  = curStep.leg_index ?? 0;

      let lastIdxInLeg = currentStepIndex;
      for (let i = currentStepIndex + 1; i < steps.length; i++) {
        const legIdx = steps[i].leg_index ?? 0;
        if (legIdx === curLeg) {
          lastIdxInLeg = i;
        } else {
          break;  // ë‹¤ìŒ leg ë¡œ ë„˜ì–´ê°„ ìˆœê°„ ì¢…ë£Œ
        }
      }

      // í˜„ì¬ leg ì˜ ë§ˆì§€ë§‰ step ì´ê³ , ì•„ì§ 'ë°°ì†¡ ì™„ë£Œ'ë¥¼ ì•ˆ ëˆŒë €ìœ¼ë©´ ë‹¤ìŒìœ¼ë¡œ ëª» ê°
      if (currentStepIndex === lastIdxInLeg) {
        const destRoutePos = curLeg + 1; // ì´ leg ì˜ ë„ì°© ëª©ì ì§€ (0ë²ˆì€ ì¶œë°œì§€)
        const stopObj = stopOverlays && stopOverlays[destRoutePos];
        const isDone  = !!(stopObj && stopObj.done);

        if (!isDone) {
          alert("ì´ ëª©ì ì§€ì˜ 'ë°°ì†¡ ì™„ë£Œ'ë¥¼ ëˆ„ë¥¸ í›„ì—ë§Œ ë‹¤ìŒìœ¼ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          return;
        }
      }

      // ì—¬ê¸°ê¹Œì§€ ì™”ìœ¼ë©´ ë‹¤ìŒ step ìœ¼ë¡œ ì´ë™í•´ë„ ë¨
      if (currentStepIndex < steps.length - 1) {
        currentStepIndex++;
      } else {
        currentStepIndex = steps.length - 1;
      }

      updateNavUI();
      highlightCurrentStepOnMap();
    }

    // When driver completes a stop
    function completeCurrentStop() {
      if (!routeData) return;

      const steps = routeData.osrm_steps || routeData.osrm_turns || [];
      if (!steps.length || currentStepIndex < 0 || currentStepIndex >= steps.length) return;

      // í˜„ì¬ step ê¸°ì¤€ìœ¼ë¡œ, ì´ leg ì˜ ë§ˆì§€ë§‰ step ì¸ì§€ í™•ì¸
      const curStep = steps[currentStepIndex];
      const curLeg  = curStep.leg_index ?? 0;

      let lastIdxInLeg = currentStepIndex;
      for (let i = currentStepIndex + 1; i < steps.length; i++) {
        const legIdx = steps[i].leg_index ?? 0;
        if (legIdx === curLeg) {
          lastIdxInLeg = i;
        } else {
          break; // ë‹¤ìŒ leg ë¡œ ë„˜ì–´ê°€ë©´ ì¢…ë£Œ
        }
      }

      // ì•„ì§ ëª©ì ì§€ì— ë„ì°©í•˜ì§€ ì•Šì€ step ì´ë©´ ë°°ì†¡ì™„ë£Œ ê¸ˆì§€
      if (currentStepIndex !== lastIdxInLeg) {
        alert("í•´ë‹¹ ëª©ì ì§€ì— ë„ì°©í•œ í›„ì—ë§Œ 'ë°°ì†¡ ì™„ë£Œ'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        return;
      }

      // ì—¬ê¸°ê¹Œì§€ ì™”ë‹¤ëŠ” ê²ƒì€ 'ë„ì°© step' ìœ„ì— ìˆë‹¤ëŠ” ëœ»
      // ì´ leg ì˜ ë„ì°© ì§€ì ì€ ë°©ë¬¸ ìˆœì„œ(curLeg+1)ì— í•´ë‹¹ (0ë²ˆì€ ì¶œë°œì§€)
      let destRoutePos = curLeg + 1;

      // ë§ˆì»¤ë¥¼ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë³€ê²½ (ì¶œë°œì§€ëŠ” 0ë²ˆì´ë¯€ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ê±´ë„ˆë›°ê²Œ ë¨)
      markStopDone(destRoutePos);

      // ì¶œë°œì§€(0ë²ˆ)ë¥¼ ì œì™¸í•œ ì™„ë£Œëœ ëª©ì ì§€ ê°œìˆ˜ ë‹¤ì‹œ ê³„ì‚°
      completedStops = stopOverlays.filter(o => o && o.done && o.routePos > 0).length;

      const totalDestStops = Math.max(0, totalStops - 1);

      // ëª¨ë“  ëª©ì ì§€ ì™„ë£Œ ì‹œ ì™„ë£Œ í™”ë©´ìœ¼ë¡œ
      if (completedStops >= totalDestStops) {
        doneSummary.textContent = `ì´ ${totalDestStops}ê±´ì˜ ë°°ì†¡ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤`;
        showScreen("done");
        return;
      }

      // step/leg ëŠ” ê·¸ëŒ€ë¡œ, UI ë§Œ ì—…ë°ì´íŠ¸
      updateNavUI();
      highlightCurrentStepOnMap();
    }

    // Event bindings
    startRouteBtn.addEventListener("click", requestOptimizedRoute);
    completeStopBtn.addEventListener("click", completeCurrentStop);
    backToMainBtn.addEventListener("click", () => showScreen("home"));
    navBackBtn.addEventListener("click", () => showScreen("home"));
    if (stepAdvanceBtn) {
      stepAdvanceBtn.addEventListener("click", goToNextStep);
    }
    // í™ˆ í™”ë©´ì—ì„œ ì…ë ¥í•  ë•Œë§ˆë‹¤ ì˜¤ëŠ˜ì˜ ë°°ì†¡ì§€ ê°œìˆ˜ ìë™ ì—…ë°ì´íŠ¸
    stopsInput.addEventListener("input", refreshTodayStopsCountFromInput);

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ê°’ ë°˜ì˜
    refreshTodayStopsCountFromInput();

    // Simple clock for home screen
    function updateClock() {
      const now = new Date();
      const hour24 = now.getHours();
      const ampm   = hour24 < 12 ? "ì˜¤ì „" : "ì˜¤í›„";
      const hour   = hour24 % 12 || 12;
      const min    = String(now.getMinutes()).padStart(2, "0");
      document.getElementById("homeTime").textContent = `${ampm} ${hour}:${min}`;

      const weekdayNames = ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "];
      const month = now.getMonth() + 1;
      const date  = now.getDate();
      const day   = weekdayNames[now.getDay()];
      document.getElementById("homeDate").textContent =
        `${month}ì›” ${date}ì¼ (${day})`;
    }
    updateClock();
    setInterval(updateClock, 30000);
  </script>
</body>
</html>

